{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="p-6 max-w-5xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Teacher Dashboard</h1>
    <div class="grid md:grid-cols-2 gap-6">
        <!-- Book a Classroom -->
        <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Book a Classroom</h2>
            <form id="bookingForm" method="post" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="classroom" class="block font-semibold">Classroom</label>
                    <select name="classroom" id="classroom" required class="w-full p-3 border rounded-lg">
                        <option value="">Select a classroom</option>
                        {% for classroom in classrooms %}
                            <option value="{{ classroom.id }}">{{ classroom.name }} ({{ classroom.block.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="date" class="block font-semibold">Date</label>
                    <input type="date" name="date" id="date" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label for="start_time" class="block font-semibold">Start Time</label>
                    <input type="time" name="start_time" id="start_time" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label for="end_time" class="block font-semibold">End Time</label>
                    <input type="time" name="end_time" id="end_time" required class="w-full p-3 border rounded-lg">
                </div>
                <button type="submit" class="btn btn-primary w-full transition-all duration-150 hover:bg-blue-700">Submit Booking</button>
            </form>
        </div>

        <!-- Upcoming Timetable -->
        <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Your Timetable</h2>
            {% if timetable %}
                <ul>
                    {% for slot in timetable %}
                        <li class="mb-2">
                            <span class="font-semibold">{{ slot.day }}</span>,
                            <span>{{ slot.start_time|time:"H:i" }} - {{ slot.end_time|time:"H:i" }}</span>
                            <span class="text-gray-500">({{ slot.classroom.name }})</span>
                            {% if slot.subject_name %} - <span>{{ slot.subject_name }}</span>{% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No timetable entries found.</p>
            {% endif %}
        </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mt-6">
        <!-- Recent Bookings -->
        <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Your Recent Bookings</h2>
            {% if bookings %}
                <ul>
                    {% for booking in bookings %}
                        <li class="mb-2">
                            <span class="font-semibold">{{ booking.classroom.name }}</span>
                            on <span>{{ booking.date }}</span>
                            <span>{{ booking.start_time|time:"H:i" }}-{{ booking.end_time|time:"H:i" }}</span>
                            <span class="badge 
                                {% if booking.status == 'approved' %}bg-green-200 text-green-800
                                {% elif booking.status == 'pending' %}bg-yellow-200 text-yellow-800
                                {% else %}bg-red-200 text-red-800{% endif %}">
                                {{ booking.get_status_display }}
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No bookings yet.</p>
            {% endif %}
        </div>

        <!-- Upcoming Events -->
        <div class="bg-white p-6 shadow rounded-lg">
            <h2 class="text-xl font-semibold mb-4">Upcoming Events</h2>
            {% if events %}
                <ul>
                    {% for event in events %}
                        <li class="mb-2">
                            <span class="font-semibold">{{ event.title }}</span>
                            <span class="text-gray-500">({{ event.start_date|date:"M d, H:i" }})</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No upcoming events.</p>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const bookingForm = document.getElementById('bookingForm');
    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(bookingForm);
        fetch("{% url 'accounts:booking-create' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.text())
        .then(html => {
            if (html.includes('Booking request submitted')) {
                Swal.fire('Success!', 'Booking submitted.', 'success');
                bookingForm.reset();
            } else {
                Swal.fire('Error', 'Failed to submit booking.', 'error');
            }
        })
        .catch(() => {
            Swal.fire('Error', 'Failed to submit booking.', 'error');
        });
    });
});
</script>
{% endblock %}

